{% extends "base.html" %}

{% block title %}Virtual Classroom - QUIZZO{% endblock %}

{% block head %}
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<style>
    [x-cloak] { display: none !important; }
    
    .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
    }
    
    .glassmorphism {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 35px 60px rgba(0, 0, 0, 0.2);
    }
</style>
<script>
// Debug AlpineJS loading
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    setTimeout(function() {
        if (window.Alpine) {
            console.log('‚úÖ AlpineJS loaded successfully');
        } else {
            console.log('‚ùå AlpineJS not loaded');
        }
    }, 1000);
});
</script>
{% endblock %}

{% block body %}
<div class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900">

    <!-- Header -->
    <div class="bg-black/20 backdrop-blur-md border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-chalkboard-teacher text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">Virtual Classroom</h1>
                        <p class="text-white/70">Interactive Learning Platform</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Simple Test Button -->
                    <button onclick="alert('JavaScript is working!')" 
                            class="bg-yellow-500 hover:bg-yellow-600 text-black px-3 py-2 rounded-lg text-sm font-bold">
                        Test JS
                    </button>
                    
                    {% if user.role == 'lecturer' %}
                    <button onclick="openCreateModal()" 
                            class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 transform hover:scale-105 shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Create Session
                    </button>
                    {% endif %}
                    <button onclick="openJoinModal()" 
                            class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 transform hover:scale-105 shadow-lg">
                        <i class="fas fa-sign-in-alt mr-2"></i>Join Session
                    </button>
                    <a href="{{ url_for('dashboard') }}" 
                       class="text-white/80 hover:text-white transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- Active Sessions -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white">üî¥ Live Sessions</h2>
                <div class="flex items-center space-x-4">
                    <div class="bg-green-100 px-3 py-1 rounded-full">
                        <span class="text-green-800 text-sm font-medium">
                            <i class="fas fa-users mr-1"></i>
                            <span id="totalParticipants">{{ total_participants or 0 }}</span> Online
                        </span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                        <span class="text-white/80 text-sm">{{ active_sessions|length }} active</span>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for session, teacher in active_sessions %}
                <div class="card rounded-2xl p-6 hover-lift">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                            <span class="text-red-600 font-semibold text-sm uppercase">Live</span>
                        </div>
                        <div class="bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 px-3 py-1 rounded-full text-xs font-semibold">
                            {{ session.session_type.title() }}
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-gray-800 mb-2">{{ session.session_name }}</h3>
                    <p class="text-gray-600 text-sm mb-4">{{ session.description[:100] }}{% if session.description|length > 100 %}...{% endif %}</p>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Host:</span>
                            <span class="font-semibold text-gray-700">{{ teacher.username }}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Room ID:</span>
                            <span class="font-mono font-bold text-indigo-600">{{ session.session_id }}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Participants:</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">
                                <i class="fas fa-users mr-1"></i>{{ session.participant_count or 0 }}
                            </span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Started:</span>
                            <span class="text-gray-700">{{ session.started_at.strftime('%H:%M') if session.started_at else 'Not started' }}</span>
                        </div>
                    </div>
                    
                    {% if session.password_protected %}
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-lock text-yellow-600"></i>
                            <span class="text-yellow-800 text-sm font-medium">Password Protected</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    <a href="{{ url_for('live_session', session_id=session.id) }}"
                       class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white py-3 px-4 rounded-xl font-bold text-center block transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-video mr-2"></i>Join Session
                    </a>
                </div>
                {% else %}
                <div class="col-span-full text-center py-12">
                    <div class="w-24 h-24 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-video-slash text-white/60 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">No Live Sessions</h3>
                    <p class="text-white/70 mb-6">No sessions are currently active. Start one or check back later!</p>
                    {% if user.role == 'lecturer' %}
                    <button onclick="openCreateModal()" 
                            class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300">
                        <i class="fas fa-plus mr-2"></i>Create First Session
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Sessions -->
        <div>
            <h2 class="text-2xl font-bold text-white mb-6">üìö Recent Sessions</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for session, teacher in my_sessions[:6] %}
                <div class="card rounded-2xl p-6 hover-lift">
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-gradient-to-r from-gray-100 to-slate-100 text-gray-700 px-3 py-1 rounded-full text-xs font-semibold">
                            {{ session.session_type.title() }}
                        </div>
                        {% if session.is_active %}
                        <span class="text-green-600 font-semibold text-sm">Active</span>
                        {% else %}
                        <span class="text-gray-500 font-semibold text-sm">Ended</span>
                        {% endif %}
                    </div>
                    
                    <h3 class="text-lg font-bold text-gray-800 mb-2">{{ session.session_name }}</h3>
                    <p class="text-gray-600 text-sm mb-4">{{ session.description[:80] }}{% if session.description|length > 80 %}...{% endif %}</p>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Created:</span>
                            <span class="text-gray-700">{{ session.created_at.strftime('%b %d, %Y') }}</span>
                        </div>
                        {% if session.ended_at %}
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Duration:</span>
                            <span class="text-gray-700">
                                {{ ((session.ended_at - session.started_at).seconds // 60) if session.started_at else 'N/A' }} min
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if session.is_active %}
                    <a href="{{ url_for('live_session', session_id=session.id) }}"
                       class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-3 px-4 rounded-xl font-bold text-center block transition-all duration-300">
                        <i class="fas fa-play mr-2"></i>Continue Session
                    </a>
                    {% else %}
                    <button class="w-full bg-gray-300 text-gray-600 py-3 px-4 rounded-xl font-bold cursor-not-allowed">
                        <i class="fas fa-archive mr-2"></i>Session Ended
                    </button>
                    {% endif %}
                </div>
                {% else %}
                <div class="col-span-full text-center py-12">
                    <div class="w-24 h-24 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-history text-white/60 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">No Recent Sessions</h3>
                    <p class="text-white/70">Your session history will appear here.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Create Session Modal -->
    {% if user.role == 'lecturer' %}
    <div id="createModal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" onclick="closeCreateModal()"></div>
            
            <div class="card max-w-md w-full mx-auto relative z-10 rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Create Live Session</h3>
                    <button onclick="closeCreateModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="createSessionForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Session Name *</label>
                        <input type="text" name="session_name" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="Enter session name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="description" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                  placeholder="Brief description of the session"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Session Type</label>
                            <select name="session_type"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="lecture">üìö Lecture</option>
                                <option value="discussion">üí¨ Discussion</option>
                                <option value="exam_review">üìù Exam Review</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Max Participants</label>
                            <input type="number" name="max_participants" value="50" min="2" max="100"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" name="password_protected" id="passwordProtected" onchange="togglePasswordField()"
                               class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="passwordProtected" class="text-sm font-medium text-gray-700">Password Protected</label>
                    </div>
                    
                    <div id="passwordField" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Session Password</label>
                        <input type="text" name="session_password"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="Enter password">
                    </div>
                    
                    <button type="submit" id="createSubmitBtn"
                            class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-3 px-4 rounded-xl font-bold transition-all duration-300">
                        <i class="fas fa-video mr-2"></i>Create & Start Session
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Join Session Modal -->
    <div id="joinModal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" onclick="closeJoinModal()"></div>
            
            <div class="card max-w-md w-full mx-auto relative z-10 rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Join Session</h3>
                    <button onclick="closeJoinModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="joinSessionForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Room ID</label>
                        <input type="text" id="joinRoomId" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent uppercase"
                               placeholder="Enter Room ID (e.g., ABC123)"
                               style="text-transform: uppercase;">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password (if required)</label>
                        <input type="password" id="joinPassword"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="Enter password if session is protected">
                    </div>
                    
                    <button type="submit" id="joinSubmitBtn"
                            class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white py-3 px-4 rounded-xl font-bold transition-all duration-300">
                        <i class="fas fa-sign-in-alt mr-2"></i>Join Session
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Simple JavaScript functions (no AlpineJS required)
console.log('Virtual classroom script loaded');

// Modal functions
function openCreateModal() {
    console.log('Opening create modal');
    document.getElementById('createModal').classList.remove('hidden');
}

function closeCreateModal() {
    console.log('Closing create modal');
    document.getElementById('createModal').classList.add('hidden');
}

function openJoinModal() {
    console.log('Opening join modal');
    document.getElementById('joinModal').classList.remove('hidden');
}

function closeJoinModal() {
    console.log('Closing join modal');
    document.getElementById('joinModal').classList.add('hidden');
}

// Toggle password field
function togglePasswordField() {
    const checkbox = document.getElementById('passwordProtected');
    const passwordField = document.getElementById('passwordField');
    if (checkbox.checked) {
        passwordField.style.display = 'block';
    } else {
        passwordField.style.display = 'none';
    }
}

// Show message function
function showMessage(type, message) {
    console.log(`Showing ${type} message:`, message);
    const messageDiv = document.createElement('div');
    messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-xl shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    messageDiv.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(messageDiv);
    
    // Remove message after 5 seconds
    setTimeout(() => {
        messageDiv.remove();
    }, 5000);
}

// Set loading state
function setLoading(buttonId, isLoading) {
    const button = document.getElementById(buttonId);
    if (isLoading) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
    } else {
        button.disabled = false;
        if (buttonId === 'createSubmitBtn') {
            button.innerHTML = '<i class="fas fa-video mr-2"></i>Create & Start Session';
        } else {
            button.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Join Session';
        }
    }
}

// Update participant counts
function updateParticipantCounts() {
    fetch('/api/participant_counts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update total participants
                const totalElement = document.getElementById('totalParticipants');
                if (totalElement) {
                    totalElement.textContent = data.total_participants;
                }
                
                // Update individual session counts (if needed for dynamic updates)
                console.log('Participant counts updated:', data);
            }
        })
        .catch(error => {
            console.error('Error fetching participant counts:', error);
        });
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing forms');
    
    // Auto-refresh participant counts every 10 seconds
    setInterval(updateParticipantCounts, 10000);
    
    // Initial load
    updateParticipantCounts();
    
    // Create session form handler
    const createForm = document.getElementById('createSessionForm');
    if (createForm) {
        console.log('Create form found, attaching event listener');
        createForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Create form submitted');
            
            setLoading('createSubmitBtn', true);
            
            const formData = new FormData(this);
            
            try {
                console.log('Sending create session request...');
                const response = await fetch('{{ url_for("create_session") }}', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response received:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    showMessage('success', `Session created! Room ID: ${data.room_id}`);
                    console.log('Session created successfully, redirecting...');
                    
                    // Close modal and redirect
                    closeCreateModal();
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 1500);
                } else {
                    throw new Error(data.error || 'Failed to create session');
                }
            } catch (error) {
                console.error('Error creating session:', error);
                showMessage('error', `Error: ${error.message}`);
                setLoading('createSubmitBtn', false);
            }
        });
    }
    
    // Join session form handler
    const joinForm = document.getElementById('joinSessionForm');
    if (joinForm) {
        console.log('Join form found, attaching event listener');
        joinForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Join form submitted');
            
            const roomId = document.getElementById('joinRoomId').value.toUpperCase().trim();
            const password = document.getElementById('joinPassword').value;
            
            if (!roomId) {
                showMessage('error', 'Please enter a Room ID');
                return;
            }
            
            setLoading('joinSubmitBtn', true);
            
            try {
                console.log('Sending join session request for Room ID:', roomId);
                const response = await fetch('{{ url_for("join_session") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        room_id: roomId,
                        password: password
                    })
                });
                
                const data = await response.json();
                console.log('Join response:', data);
                
                if (data.success) {
                    showMessage('success', 'Joining session...');
                    closeJoinModal();
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Failed to join session');
                }
            } catch (error) {
                console.error('Error joining session:', error);
                showMessage('error', `Error: ${error.message}`);
                setLoading('joinSubmitBtn', false);
            }
        });
    }
    
    console.log('Virtual classroom initialization complete');
});
</script>

{% endblock %}