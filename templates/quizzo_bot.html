{% extends "base.html" %}

{% block title %}Quizzo Bot - Your AI Assistant{% endblock %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    .chat-container {
        height: calc(100vh - 120px);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .chat-sidebar {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        transition: transform 0.3s ease;
    }
    
    .chat-main {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 60px);
            flex-direction: column;
        }
        
        .chat-sidebar {
            position: fixed;
            top: 60px;
            left: 0;
            width: 85%;
            max-width: 320px;
            height: calc(100vh - 60px);
            z-index: 50;
            transform: translateX(-100%);
            border-right: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chat-sidebar.open {
            transform: translateX(0);
        }
        
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: none;
        }
        
        .mobile-overlay.show {
            display: block;
        }
        
        .chat-main {
            flex: 1;
            width: 100%;
        }
        
        .chat-header-mobile {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .mobile-menu-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 1.1rem;
        }
        
        .message-bubble {
            max-width: 85%;
        }
        
        .chat-input {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        /* Hide desktop elements on mobile */
        .desktop-only {
            display: none;
        }
        
        /* Mobile input area adjustments */
        #messagesContainer {
            padding: 1rem;
        }
        
        /* Better touch targets */
        .quick-actions button {
            padding: 0.75rem;
            font-size: 0.875rem;
        }
    }
    
    /* Landscape orientation adjustments */
    @media (max-width: 768px) and (orientation: landscape) {
        .chat-container {
            height: calc(100vh - 50px);
        }
        
        .chat-sidebar {
            top: 50px;
            height: calc(100vh - 50px);
        }
        
        .chat-header-mobile {
            padding: 0.5rem 1rem;
        }
        
        #messagesContainer {
            padding: 0.75rem;
        }
    }
    
    /* Desktop styles */
    @media (min-width: 769px) {
        .chat-header-mobile {
            display: none;
        }
        
        .mobile-only {
            display: none;
        }
    }
    
    /* Touch-friendly interactions */
    @media (hover: none) and (pointer: coarse) {
        .session-item,
        .quick-actions button,
        button {
            min-height: 44px; /* Apple's recommended touch target */
            padding: 0.75rem 1rem;
        }
        
        .message-bubble {
            font-size: 16px;
            line-height: 1.5;
        }
        
        /* Enhanced send button for mobile */
        #sendButton {
            min-width: 56px;
            min-height: 56px;
            padding: 1rem;
            font-size: 1.2rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        #sendButton:hover,
        #sendButton:active {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: scale(1.05);
        }
        
        #sendButton:disabled {
            background: rgba(255, 255, 255, 0.2);
            transform: none;
        }
    }
    
    /* Mobile send button styling */
    @media (max-width: 768px) {
        #sendButton {
            min-width: 48px;
            min-height: 48px;
            padding: 0.75rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 3px 10px rgba(59, 130, 246, 0.4);
            transition: all 0.2s ease;
        }
        
        #sendButton:active {
            transform: scale(0.95);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.6);
        }
        
        #sendButton i {
            font-size: 1.1rem;
        }
        
        /* Make input area more touch-friendly */
        .chat-input {
            min-height: 48px;
            padding: 0.75rem 1rem;
            border-radius: 24px;
        }
        
        /* Improve input form layout on mobile */
        #chatForm {
            align-items: flex-end;
            gap: 0.75rem;
        }
        
        /* Send button states for better UX */
        #sendButton:not(:disabled) {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 3px 10px rgba(16, 185, 129, 0.4);
        }
        
        #sendButton:not(:disabled):active {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
    }
    
    .message-bubble {
        max-width: 70%;
        word-wrap: break-word;
    }
    
    .message-user {
        background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
        color: #1e293b;
        border-radius: 18px 18px 5px 18px;
        margin-left: auto;
        font-weight: bold;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .message-bot {
        background: rgba(255, 255, 255, 0.95);
        color: #1f2937;
        border-radius: 18px 18px 18px 5px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        font-weight: 600;
    }
    
    .typing-indicator {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 18px;
        padding: 12px 16px;
        margin-bottom: 16px;
    }
    
    .typewriter-text {
        border-right: 2px solid #3b82f6;
        animation: blink-cursor 1s infinite;
    }
    
    @keyframes blink-cursor {
        0%, 50% { border-right-color: #3b82f6; }
        51%, 100% { border-right-color: transparent; }
    }
    
    .typing-dots {
        display: inline-block;
    }
    
    .typing-dots span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #9ca3af;
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-10px); opacity: 1; }
    }
    
    .chat-input {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: 500;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.5);
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
    }
    
    .chat-input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }
    
    .quick-actions {
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .session-item {
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }
    
    .session-item:hover {
        background: rgba(0, 0, 0, 0.3);
        transform: translateY(-2px);
    }
    
    .bot-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-right: 12px;
        flex-shrink: 0;
    }
    
    .user-avatar {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-left: 12px;
        flex-shrink: 0;
    }
    
    /* Bot message formatting styles */
    .bot-message ul {
        margin: 8px 0;
        padding-left: 0;
        list-style: none;
    }
    
    .bot-message li {
        margin: 6px 0;
        padding-left: 20px;
        position: relative;
        line-height: 1.4;
    }
    
    .bot-message li:before {
        content: "‚Ä¢";
        color: #667eea;
        font-weight: bold;
        position: absolute;
        left: 8px;
    }
    
    .bot-message strong {
        color: #667eea;
        font-weight: 600;
    }
    
    .bot-message p {
        margin: 4px 0;
        line-height: 1.4;
    }
</style>
{% endblock %}

{% block content %}
<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileSidebar()"></div>

<div class="chat-container flex">
    <!-- Mobile Header -->
    <div class="chat-header-mobile mobile-only">
        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <h1 class="text-white font-semibold">Quizzo Bot</h1>
        <button class="mobile-menu-btn" onclick="createNewChat()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Sidebar -->
    <div class="chat-sidebar w-80 p-6 overflow-y-auto" id="chatSidebar">
        <!-- Header -->
        <div class="mb-6">
            <div class="flex items-center mb-4">
                <div class="bot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-black">Quizzo Bot</h1>
                    <p class="text-gray-800 text-sm font-medium">Your AI Assistant</p>
                </div>
            </div>
            
            <!-- New Chat Button -->
            <button onclick="createNewChat()" 
                    class="w-full bg-white/20 hover:bg-white/30 text-black font-bold py-3 px-4 rounded-lg transition-all duration-300 border border-white/30">
                <i class="fas fa-plus mr-2"></i>New Chat
            </button>
        </div>
        
        <!-- Recent Sessions -->
        <div class="mb-6">
            <h3 class="text-black font-semibold mb-3">Recent Chats</h3>
            <div id="recentSessions" class="space-y-2">
                {% for session in recent_sessions %}
                <div class="session-item p-3 rounded-lg cursor-pointer" onclick="window.innerWidth <= 768 ? loadChatSessionMobile({{ session.id }}) : loadChatSession({{ session.id }})">
                    <div class="text-black text-sm font-bold truncate">{{ session.session_title }}</div>
                    <div class="text-gray-700 text-xs mt-1 font-medium">
                        {{ session.message_count }} messages ‚Ä¢ {{ session.last_activity.strftime('%m/%d %H:%M') }}
                    </div>
                </div>
                {% endfor %}
                
                {% if not recent_sessions %}
                <div class="text-gray-700 text-sm text-center py-4 font-medium">
                    No previous chats yet.<br>Start a new conversation!
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions p-4 rounded-lg">
            <h4 class="text-black font-bold mb-3">Quick Help</h4>
            <div class="space-y-2 text-sm">
                <button onclick="askQuickQuestion('How do I take a challenge?')" 
                        class="w-full text-left text-black font-bold hover:text-gray-800 p-2 rounded hover:bg-white/20 transition-colors">
                    üéØ How to take challenges
                </button>
                <button onclick="askQuickQuestion('Explain the points system')" 
                        class="w-full text-left text-black font-bold hover:text-gray-800 p-2 rounded hover:bg-white/20 transition-colors">
                    üèÜ Points & Rankings
                </button>
                <button onclick="askQuickQuestion('How do I join a virtual classroom?')" 
                        class="w-full text-left text-black font-bold hover:text-gray-800 p-2 rounded hover:bg-white/20 transition-colors">
                    üíª Virtual Classroom
                </button>
                <button onclick="askQuickQuestion('Give me study tips')" 
                        class="w-full text-left text-black font-bold hover:text-gray-800 p-2 rounded hover:bg-white/20 transition-colors">
                    üìö Study Tips
                </button>
            </div>
        </div>
        
        <!-- Back to Dashboard -->
        <div class="mt-6">
            <a href="{{ url_for('dashboard') }}" 
               class="w-full bg-white/10 hover:bg-white/20 text-black font-bold py-2 px-4 rounded-lg transition-colors border border-white/20 text-center block">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="chat-main flex-1 flex flex-col">
        <!-- Chat Header -->
        <div class="bg-white/10 backdrop-blur-lg border-b border-white/20 p-4 desktop-only">
            <div class="flex items-center justify-between">
                <div>
                    <h2 id="chatTitle" class="text-white font-semibold">Quizzo Bot - Chat with {{ user_name }}</h2>
                    <p class="text-white/70 text-sm">Ask me about QUIZZO features or academic topics</p>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="statusIndicator" class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-white/80 text-sm">Online</span>
                </div>
            </div>
        </div>
        
        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto p-6" id="messagesContainer">
            <!-- Welcome Message -->
            <div id="welcomeMessage" class="flex items-start mb-6">
                <div class="bot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-bubble message-bot p-4">
                    <div class="text-sm font-bold text-gray-900 mb-2">Quizzo Bot</div>
                    <div class="text-gray-900 font-semibold">
                        üëã Welcome {{ user_name }}! I'm your AI assistant for all things QUIZZO and education.
                        <br><br>
                        I can help you with:
                        <br>üéØ Platform features and navigation
                        <br>üèÜ Challenges and point system  
                        <br>üíª Virtual classroom setup
                        <br>üìö Study tips and academic support
                        <br><br>
                        What would you like to know?
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Typing Indicator -->
        <div id="typingIndicator" class="px-6 hidden">
            <div class="flex items-start">
                <div class="bot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span id="typingText" class="ml-2 text-gray-800 text-sm font-semibold">Quizzo Bot is thinking...</span>
                </div>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="bg-white/10 backdrop-blur-lg border-t border-white/20 p-4">
            <form id="chatForm" class="flex items-center space-x-3">
                <div class="flex-1 relative">
                    <input type="text" 
                           id="messageInput" 
                           placeholder="Ask me anything about QUIZZO or your studies..."
                           class="w-full chat-input rounded-lg py-3 px-4 pr-12 focus:outline-none focus:ring-2 focus:ring-white/30"
                           autocomplete="off">
                </div>
                <button type="submit" 
                        id="sendButton"
                        disabled
                        class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-lg transition-all duration-300 border border-white/30 disabled:opacity-50 disabled:cursor-not-allowed opacity-50">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
            
            <!-- Quick Suggestions -->
            <div id="quickSuggestions" class="mt-3 flex flex-wrap gap-2">
                <button onclick="askQuickQuestion('How do speed challenges work?')" 
                        class="bg-white/10 hover:bg-white/20 text-white/80 text-xs px-3 py-1 rounded-full transition-colors">
                    Speed Challenges
                </button>
                <button onclick="askQuickQuestion('What are the app features?')" 
                        class="bg-white/10 hover:bg-white/20 text-white/80 text-xs px-3 py-1 rounded-full transition-colors">
                    App Features
                </button>
                <button onclick="askQuickQuestion('Help me study better')" 
                        class="bg-white/10 hover:bg-white/20 text-white/80 text-xs px-3 py-1 rounded-full transition-colors">
                    Study Tips
                </button>
            </div>
        </div>
    </div>
</div>
        <!-- Input Area -->
        <div class="border-t border-gray-200 p-4 bg-white">
            <div class="max-w-3xl mx-auto">
                <form id="chatForm" class="relative">
                    <div class="flex items-end space-x-3">
                        <div class="flex-1">
                            <textarea id="messageInput" 
                                   placeholder="Message Quizzo Bot..."
                                   class="chat-input w-full rounded-lg resize-none focus:outline-none"
                                   rows="1"
                                   autocomplete="off"></textarea>
                        </div>
                        <button type="submit" 
                                id="sendButton"
                                class="send-btn disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </form>
                
                <!-- Quick suggestions -->
                <div class="mt-2 flex flex-wrap gap-2">
                    <button onclick="askQuickQuestion('How do speed challenges work?')" 
                            class="text-xs text-gray-500 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full transition-colors">
                        Speed Challenges
                    </button>
                    <button onclick="askQuickQuestion('What are the app features?')" 
                            class="text-xs text-gray-500 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full transition-colors">
                        App Features
                    </button>
                    <button onclick="askQuickQuestion('Help me study better')" 
                            class="text-xs text-gray-500 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full transition-colors">
                        Study Tips
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="fixed top-4 right-4 z-50"></div>

<script>
let currentSessionId = null;
let isTyping = false;

// Initialize chat on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Quizzo Bot initialized');
    
    // Focus on input
    document.getElementById('messageInput').focus();
    
    // Handle form submission
    document.getElementById('chatForm').addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // Handle enter key in input
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Update send button state based on input content
    document.getElementById('messageInput').addEventListener('input', function(e) {
        const sendButton = document.getElementById('sendButton');
        const hasContent = e.target.value.trim().length > 0;
        
        if (hasContent) {
            sendButton.classList.remove('opacity-50');
            sendButton.classList.add('opacity-100');
            sendButton.disabled = false;
        } else {
            sendButton.classList.add('opacity-50');
            sendButton.classList.remove('opacity-100');
            sendButton.disabled = true;
        }
    });
    
    // Create initial session
    createNewChat();
});

// Create new chat session
async function createNewChat() {
    try {
        const response = await fetch('/api/quizzo-bot/new-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        if (data.success) {
            currentSessionId = data.session_id;
            clearMessages();
            showWelcomeMessage();
            updateChatTitle('New Chat');
            console.log('New chat session created:', currentSessionId);
        } else {
            showNotification('error', 'Failed to create new chat session');
        }
    } catch (error) {
        console.error('Error creating new chat:', error);
        showNotification('error', 'Connection error');
    }
}

// Load existing chat session
async function loadChatSession(sessionId) {
    try {
        currentSessionId = sessionId;
        
        const response = await fetch(`/api/quizzo-bot/session/${sessionId}/messages`);
        const data = await response.json();
        
        if (data.success) {
            clearMessages();
            updateChatTitle(data.session_title);
            
            // Display messages
            data.messages.forEach(msg => {
                if (msg.message_type === 'user') {
                    displayUserMessage(msg.message);
                } else {
                    displayBotMessage(msg.message);
                }
            });
            
            // Scroll to bottom
            scrollToBottom();
        } else {
            showNotification('error', 'Failed to load chat session');
        }
    } catch (error) {
        console.error('Error loading chat session:', error);
        showNotification('error', 'Connection error');
    }
}

// Send message
async function sendMessage() {
    if (!currentSessionId) {
        await createNewChat();
    }
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message || isTyping) return;
    
    // Disable input and show user message
    messageInput.value = '';
    messageInput.disabled = true;
    document.getElementById('sendButton').disabled = true;
    
    displayUserMessage(message);
    showTypingIndicator();
    
    try {
        const response = await fetch(`/api/quizzo-bot/session/${currentSessionId}/send`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Simulate more realistic response timing
            await simulateRealisticTyping(data.bot_response.message, data.bot_response.id);
            
            // Update title if it's a new chat
            if (data.bot_response && document.getElementById('chatTitle').textContent === 'New Chat') {
                updateChatTitle(message.length > 30 ? message.substring(0, 30) + '...' : message);
            }
        } else {
            hideTypingIndicator();
            displayBotMessage('Sorry, I encountered an error. Please try again.', null, true);
            showNotification('error', data.error || 'Failed to send message');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        hideTypingIndicator();
        displayBotMessage('Sorry, I\'m having connection issues. Please try again.', null, true);
        showNotification('error', 'Connection error');
    } finally {
        // Re-enable input
        messageInput.disabled = false;
        const sendButton = document.getElementById('sendButton');
        sendButton.disabled = true; // Will be enabled by input event listener if there's content
        sendButton.classList.add('opacity-50');
        sendButton.classList.remove('opacity-100');
        messageInput.focus();
    }
}

// Quick question helper
function askQuickQuestion(question) {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    
    messageInput.value = question;
    
    // Enable send button since we have content
    sendButton.disabled = false;
    sendButton.classList.remove('opacity-50');
    sendButton.classList.add('opacity-100');
    
    sendMessage();
}

// Display user message
function displayUserMessage(message) {
    const container = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start justify-end mb-6';
    
    messageDiv.innerHTML = `
        <div class="message-bubble message-user p-4">
            <div class="text-gray-900 font-bold">${escapeHtml(message)}</div>
            <div class="text-gray-700 text-xs mt-2 font-medium">${formatTime(new Date())}</div>
        </div>
        <div class="user-avatar">
            <i class="fas fa-user"></i>
        </div>
    `;
    
    container.appendChild(messageDiv);
    scrollToBottom();
}

// Display bot message
function displayBotMessage(message, messageId = null, isError = false) {
    const container = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start mb-6';
    
    const feedbackButtons = messageId && !isError ? `
        <div class="flex items-center space-x-2 mt-3">
            <button onclick="provideFeedback(${messageId}, true)" 
                    class="text-xs text-gray-700 hover:text-green-600 transition-colors font-medium">
                <i class="fas fa-thumbs-up mr-1"></i>Helpful
            </button>
            <button onclick="provideFeedback(${messageId}, false)" 
                    class="text-xs text-gray-700 hover:text-red-600 transition-colors font-medium">
                <i class="fas fa-thumbs-down mr-1"></i>Not helpful
            </button>
        </div>
    ` : '';
    
    messageDiv.innerHTML = `
        <div class="bot-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-bubble message-bot p-4">
            <div class="text-sm font-bold text-gray-900 mb-2">Quizzo Bot</div>
            <div class="bot-message text-gray-900 font-semibold">${formatBotMessage(message)}</div>
            <div class="text-gray-700 text-xs mt-2 font-medium">${formatTime(new Date())}</div>
            ${feedbackButtons}
        </div>
    `;
    
    container.appendChild(messageDiv);
    scrollToBottom();
}

// Format bot message with markdown-like formatting
function formatBotMessage(message) {
    // First, convert **text** to <strong>text</strong>
    let formatted = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert *text* to <em>text</em> 
    formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Split into lines to handle bullet points properly
    let lines = formatted.split('\n');
    let result = [];
    let inList = false;
    
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        
        if (line.startsWith('‚Ä¢ ')) {
            // This is a bullet point
            if (!inList) {
                result.push('<ul>');
                inList = true;
            }
            result.push('<li>' + line.substring(2) + '</li>');
        } else if (line === '') {
            // Empty line - close list and add space
            if (inList) {
                result.push('</ul>');
                inList = false;
            }
            result.push('<div style="margin: 8px 0;"></div>');
        } else {
            // Regular text line
            if (inList) {
                result.push('</ul>');
                inList = false;
            }
            
            // Check if this is a section header (contains <strong>)
            if (line.includes('<strong>')) {
                result.push('<div style="margin: 12px 0 6px 0;">' + line + '</div>');
            } else if (line !== '') {
                result.push('<div style="margin: 4px 0;">' + line + '</div>');
            }
        }
    }
    
    // Close any open list
    if (inList) {
        result.push('</ul>');
    }
    
    // Style emojis with larger text
    return result.join('').replace(/üéØ|üèÜ|üíª|üìö|üìä|‚ö°|üé•|üé§|üí¨|üë•|üì±|‚ú®|‚úçÔ∏è|üîç|üìñ|üìä|üëã/g, '<span class="text-lg">$&</span>');
}

// Provide feedback on bot response
async function provideFeedback(messageId, isHelpful) {
    try {
        const response = await fetch('/api/quizzo-bot/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message_id: messageId,
                is_helpful: isHelpful
            })
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('success', 'Thank you for your feedback!', 2000);
        }
    } catch (error) {
        console.error('Error providing feedback:', error);
    }
}

// Show typing indicator
function showTypingIndicator() {
    isTyping = true;
    document.getElementById('typingIndicator').classList.remove('hidden');
    scrollToBottom();
}

// Hide typing indicator
function hideTypingIndicator() {
    isTyping = false;
    document.getElementById('typingIndicator').classList.add('hidden');
}

// Simulate realistic typing with thinking and typing phases
async function simulateRealisticTyping(message, messageId) {
    const typingText = document.getElementById('typingText');
    
    // Phase 1: Thinking (1-2 seconds)
    typingText.textContent = 'Quizzo Bot is thinking...';
    await sleep(1000 + Math.random() * 1000); // 1-2 seconds
    
    // Phase 2: Start typing
    typingText.textContent = 'Quizzo Bot is typing...';
    await sleep(500 + Math.random() * 500); // 0.5-1 second
    
    // Phase 3: Hide typing indicator and show message with typewriter effect
    hideTypingIndicator();
    await displayBotMessageWithTypewriter(message, messageId);
}

// Display bot message with typewriter effect
async function displayBotMessageWithTypewriter(message, messageId) {
    const messagesContainer = document.getElementById('messagesContainer');
    
    // Create the message bubble
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start mb-6';
    messageDiv.innerHTML = `
        <div class="bot-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-bubble message-bot p-4" data-message-id="${messageId}">
            <div class="text-sm font-bold text-gray-900 mb-2">Quizzo Bot</div>
            <div class="text-gray-900 font-semibold typewriter-text" id="typewriter-${messageId}"></div>
            <div class="mt-3 flex space-x-2">
                <button onclick="provideFeedback(${messageId}, true)" 
                        class="px-3 py-1 bg-green-100 text-green-800 rounded-lg text-xs hover:bg-green-200 transition-colors">
                    üëç Helpful
                </button>
                <button onclick="provideFeedback(${messageId}, false)" 
                        class="px-3 py-1 bg-red-100 text-red-800 rounded-lg text-xs hover:bg-red-200 transition-colors">
                    üëé Not helpful
                </button>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
    
    // Start typewriter effect
    const typewriterElement = document.getElementById(`typewriter-${messageId}`);
    typewriterElement.classList.add('bot-message'); // Add bot-message class for styling
    await typewriterEffect(typewriterElement, message);
    
    // Remove cursor after typing is complete
    typewriterElement.classList.remove('typewriter-text');
}

// Typewriter effect function with real-time formatting
async function typewriterEffect(element, text) {
    element.innerHTML = '';
    
    // Calculate typing speed based on message length (faster for longer messages)
    const baseSpeed = 30; // Base typing speed in ms
    const maxSpeed = 15;  // Fastest typing speed
    const minSpeed = 50;  // Slowest typing speed
    
    const typingSpeed = Math.max(maxSpeed, Math.min(minSpeed, baseSpeed - (text.length / 20)));
    
    let currentText = '';
    
    for (let i = 0; i < text.length; i++) {
        currentText += text.charAt(i);
        
        // Format the current text and update the element
        element.innerHTML = formatBotMessage(currentText);
        
        // Add slight variations in typing speed
        const variation = (Math.random() - 0.5) * 10;
        const currentSpeed = typingSpeed + variation;
        
        // Pause longer for punctuation
        if (text.charAt(i).match(/[.!?:;]/)) {
            await sleep(currentSpeed * 3);
        } else if (text.charAt(i) === ',') {
            await sleep(currentSpeed * 2);
        } else if (text.charAt(i) === ' ') {
            await sleep(currentSpeed * 0.5);
        } else {
            await sleep(currentSpeed);
        }
        
        // Scroll to keep the typing visible
        scrollToBottom();
    }
}

// Helper function for delays
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Show welcome message
function showWelcomeMessage() {
    const welcomeMsg = document.getElementById('welcomeMessage');
    if (welcomeMsg) {
        welcomeMsg.style.display = 'flex';
    }
}

// Clear messages
function clearMessages() {
    const container = document.getElementById('messagesContainer');
    if (container) {
        // Remove all dynamically added messages but keep the welcome message
        const children = Array.from(container.children);
        children.forEach(child => {
            if (child.id !== 'welcomeMessage') {
                child.remove();
            }
        });
        
        // Show welcome message
        const welcomeMsg = document.getElementById('welcomeMessage');
        if (welcomeMsg) {
            welcomeMsg.style.display = 'flex';
        }
    }
}

// Update chat title
function updateChatTitle(title) {
    const titleElement = document.getElementById('chatTitle');
    if (titleElement) {
        titleElement.textContent = title;
    }
}

// Scroll to bottom
function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    if (container) {
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTime(date) {
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function showNotification(type, message, duration = 5000) {
    const container = document.getElementById('notificationContainer');
    const notification = document.createElement('div');
    
    notification.className = `px-6 py-4 rounded-lg shadow-lg text-white mb-2 transform translate-x-full transition-transform duration-300 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    }`;
    
    notification.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    container.appendChild(notification);
    
    // Show notification
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Hide and remove notification
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, duration);
}

// Attach file (placeholder)
function attachFile() {
    showNotification('info', 'File attachment feature coming soon!', 3000);
}

// Mobile responsive functions
function toggleMobileSidebar() {
    const sidebar = document.getElementById('chatSidebar');
    const overlay = document.getElementById('mobileOverlay');
    
    sidebar.classList.toggle('open');
    overlay.classList.toggle('show');
}

function closeMobileSidebar() {
    const sidebar = document.getElementById('chatSidebar');
    const overlay = document.getElementById('mobileOverlay');
    
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
}

// Close sidebar when clicking on a chat session (mobile)
function loadChatSessionMobile(sessionId) {
    loadChatSession(sessionId);
    closeMobileSidebar();
}

// Handle window resize
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        closeMobileSidebar();
    }
});

// Handle touch gestures for better mobile experience
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleGesture();
});

function handleGesture() {
    const swipeThreshold = 50;
    const swipeDistance = touchEndX - touchStartX;
    
    // Swipe right to open sidebar (from left edge)
    if (swipeDistance > swipeThreshold && touchStartX < 50 && window.innerWidth <= 768) {
        toggleMobileSidebar();
    }
    
    // Swipe left to close sidebar
    if (swipeDistance < -swipeThreshold && window.innerWidth <= 768) {
        closeMobileSidebar();
    }
}
</script>
{% endblock %}