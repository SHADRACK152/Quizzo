{% extends "base.html" %}

{% block title %}Challenges - QUIZZO{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Available Challenges</h1>
            <p class="text-gray-600 mt-2">Test your knowledge and compete with others</p>
        </div>
        <div class="flex space-x-3">
            <a href="{{ url_for('student_rankings') }}" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200">
                <i class="fas fa-trophy mr-2"></i>Rankings
            </a>
            <a href="{{ url_for('student_challenge_history') }}" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200">
                <i class="fas fa-history mr-2"></i>View History
            </a>
            <a href="{{ url_for('dashboard') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label for="search" class="block text-sm font-medium text-gray-700 mb-2">Search Challenges</label>
                <input type="text" id="search" placeholder="Search by title or topic..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                       onkeyup="filterChallenges()">
            </div>
            <div>
                <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-2">Challenge Type</label>
                <select id="type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onchange="filterChallenges()">
                    <option value="">All Types</option>
                    <option value="speed_quiz">Speed Quiz</option>
                    <option value="accuracy_challenge">Accuracy Challenge</option>
                    <option value="mixed">Mixed Challenge</option>
                    <option value="knowledge_test">Knowledge Test</option>
                </select>
            </div>
            <div>
                <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onchange="filterChallenges()">
                    <option value="">All</option>
                    <option value="available">Available</option>
                    <option value="completed">Completed</option>
                    <option value="in-progress">In Progress</option>
                </select>
            </div>
            <div class="flex items-end">
                <button onclick="resetFilters()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
                    Reset Filters
                </button>
            </div>
        </div>
    </div>

    <!-- My Progress Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">My Challenge Progress</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="text-center">
                <div class="text-3xl font-bold text-blue-600">{{ my_stats.total_challenges or 0 }}</div>
                <div class="text-sm text-gray-600">Challenges Taken</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-green-600">{{ my_stats.completed or 0 }}</div>
                <div class="text-sm text-gray-600">Completed</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-purple-600">{{ my_stats.average_score or 0 }}%</div>
                <div class="text-sm text-gray-600">Average Score</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-yellow-600">{{ my_stats.best_rank or 'N/A' }}</div>
                <div class="text-sm text-gray-600">Best Rank</div>
            </div>
        </div>
    </div>

    <!-- Challenges Grid -->
    <div id="challenges-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for challenge in challenges %}
        <div class="challenge-card bg-white rounded-lg shadow-md hover:shadow-lg transition duration-200" 
             data-type="{{ challenge.challenge_type }}" 
             data-title="{{ challenge.title.lower() }}"
             data-status="{% if challenge.user_sessions %}completed{% else %}available{% endif %}"
             data-challenge-id="{{ challenge.id }}"
             data-has-time-limit="{% if challenge.time_limit_minutes %}true{% else %}false{% endif %}">
            <div class="p-6">
                <!-- Challenge Header -->
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">{{ challenge.title }}</h3>
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                            Challenge
                        </span>
                    </div>
                    <div class="text-right">
                        {% if challenge.user_sessions %}
                            {% set best_session = challenge.user_sessions[0] %}
                            {% if best_session.percentage >= (challenge.passing_score or 70) %}
                                <i class="fas fa-check-circle text-green-500 text-xl"></i>
                            {% else %}
                                <i class="fas fa-times-circle text-red-500 text-xl"></i>
                            {% endif %}
                        {% else %}
                            <i class="fas fa-circle text-gray-300 text-xl"></i>
                        {% endif %}
                    </div>
                </div>

                <!-- Challenge Description -->
                <p class="text-gray-600 text-sm mb-4 line-clamp-2">{{ challenge.description or 'No description available' }}</p>

                <!-- Progress Bar (if attempted) -->
                {% if challenge.user_sessions %}
                    {% set best_session = challenge.user_sessions[0] %}
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium {% if best_session.percentage >= (challenge.passing_score or 70) %}text-green-600{% else %}text-red-600{% endif %}">
                                Best Score: {{ best_session.percentage }}%
                            </span>
                            <span class="text-sm text-gray-500">{{ challenge.user_sessions|length }} attempt(s)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="{% if best_session.percentage >= (challenge.passing_score or 70) %}bg-green-600{% else %}bg-red-600{% endif %} h-2 rounded-full" 
                                 style="width: {{ best_session.percentage }}%"></div>
                        </div>
                    </div>
                {% endif %}

                <!-- Challenge Stats -->
                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                    <div class="flex items-center">
                        <i class="fas fa-clock text-gray-400 mr-2"></i>
                        <span>
                            {% if challenge.time_limit_minutes %}
                                {{ challenge.time_limit_minutes }} min
                                <span class="text-xs text-red-600 ml-1">(Speed Mode)</span>
                            {% else %}
                                No Limit
                            {% endif %}
                        </span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-question-circle text-gray-400 mr-2"></i>
                        <span>{{ challenge.question_count or 'N/A' }} Questions</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-trophy text-gray-400 mr-2"></i>
                        <span>{{ challenge.passing_score or 70 }}% to Pass</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-star text-gray-400 mr-2"></i>
                        <span>{{ challenge.difficulty|title or 'Medium' }}</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-6">
                    {% if challenge.user_sessions %}
                        <div class="flex space-x-2">
                            <button onclick="viewResults({{ challenge.user_sessions[0].id }})" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200 text-sm">
                                View Results
                            </button>
                            {% if not challenge.max_attempts or challenge.user_sessions|length < challenge.max_attempts %}
                                <button onclick="startChallenge({{ challenge.id }})" 
                                        class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200 text-sm">
                                    Retake
                                </button>
                            {% else %}
                                <span class="flex-1 bg-gray-400 text-white px-4 py-2 rounded-lg font-medium text-sm text-center">
                                    Max Attempts
                                </span>
                            {% endif %}
                        </div>
                    {% else %}
                        <button onclick="startChallenge({{ challenge.id }})" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
                            Start Challenge
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Empty State -->
    <div id="no-challenges" class="text-center py-12 hidden">
        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No challenges found</h3>
        <p class="text-gray-500">Try adjusting your search criteria or check back later for new challenges.</p>
    </div>
</div>

<!-- Challenge Start Modal -->
<div id="challenge-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Start Challenge</h3>
        <p class="text-gray-600 mb-4">Are you ready to start the challenge? Make sure you are prepared before proceeding.</p>
        
        <div id="speed-mode-warning" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
            <div class="flex items-center">
                <i class="fas fa-bolt text-yellow-600 mr-2"></i>
                <div>
                    <p class="text-sm font-medium text-yellow-800">Speed Answering Mode</p>
                    <p class="text-xs text-yellow-600">Each question has a time limit. Answer quickly!</p>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end space-x-4">
            <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-medium transition duration-200">
                Cancel
            </button>
            <button id="confirm-start-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition duration-200">
                Start Challenge
            </button>
        </div>
    </div>
</div>

<script>
    let selectedChallengeId = null;

    function showModal(challengeId) {
        selectedChallengeId = challengeId;
        
        // Find the challenge data to check if it has time limit
        const challengeCard = document.querySelector(`[data-challenge-id="${challengeId}"]`);
        const hasTimeLimit = challengeCard && challengeCard.dataset.hasTimeLimit === 'true';
        
        // Show speed mode warning if challenge has time limit
        const speedWarning = document.getElementById('speed-mode-warning');
        if (hasTimeLimit && speedWarning) {
            speedWarning.classList.remove('hidden');
        } else if (speedWarning) {
            speedWarning.classList.add('hidden');
        }
        
        document.getElementById('challenge-modal').classList.remove('hidden');
    }

    function closeModal() {
        selectedChallengeId = null;
        document.getElementById('challenge-modal').classList.add('hidden');
    }

    function startChallenge(challengeId) {
        if (challengeId) {
            selectedChallengeId = challengeId;
            showModal(challengeId);
        }
    }

    function viewResults(sessionId) {
        if (sessionId) {
            window.location.href = `/challenge/session/${sessionId}/results`;
        }
    }

    function confirmStart() {
        if (selectedChallengeId) {
            window.location.href = `/challenge/${selectedChallengeId}/start`;
        }
    }

    document.getElementById('confirm-start-btn').addEventListener('click', confirmStart);

    // Search functionality
    function filterChallenges() {
        const searchTerm = document.getElementById('search').value.toLowerCase();
        const typeFilter = document.getElementById('type-filter').value;
        const statusFilter = document.getElementById('status-filter').value;
        const challenges = document.querySelectorAll('.challenge-card');
        let visibleCount = 0;

        challenges.forEach(challenge => {
            const title = challenge.dataset.title;
            const type = challenge.dataset.type;
            const status = challenge.dataset.status;
            
            let showChallenge = true;
            
            // Filter by search term
            if (searchTerm && !title.includes(searchTerm)) {
                showChallenge = false;
            }
            
            // Filter by type
            if (typeFilter && type !== typeFilter) {
                showChallenge = false;
            }
            
            // Filter by status
            if (statusFilter && status !== statusFilter) {
                showChallenge = false;
            }
            
            if (showChallenge) {
                challenge.style.display = 'block';
                visibleCount++;
            } else {
                challenge.style.display = 'none';
            }
        });

        // Show/hide empty state
        const noChallenges = document.getElementById('no-challenges');
        if (visibleCount === 0) {
            noChallenges.classList.remove('hidden');
        } else {
            noChallenges.classList.add('hidden');
        }
    }

    function resetFilters() {
        document.getElementById('search').value = '';
        document.getElementById('type-filter').value = '';
        document.getElementById('status-filter').value = '';
        filterChallenges();
    }
</script>

{% endblock %}